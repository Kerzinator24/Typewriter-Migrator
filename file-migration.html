<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zip File Uploader</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @keyframes slideInFromTop {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center h-screen">
<h1 class="text-4xl font-bold mb-8">Zip File Uploader</h1>
<div id="uploadArea">
  <input type="file" id="fileInput" class="hidden" accept=".zip">
  <button id="uploadButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out">Upload Zip File</button>
</div>

<script>
  document.getElementById('uploadButton').addEventListener('click', function() {
    document.getElementById('fileInput').click();
  });

  document.getElementById('fileInput').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const arrayBuffer = e.target.result;
      unzipAndRezip(arrayBuffer);
    };
    reader.readAsArrayBuffer(file);
  });

  function unzipAndRezip(arrayBuffer) {
    JSZip.loadAsync(arrayBuffer).then(function(zip) {
      const newZip = new JSZip();
      zip.forEach(function(relativePath, zipEntry) {
        if (!zipEntry.dir) { // Skip directories
          newZip.file(zipEntry.name, zipEntry.async("arraybuffer"), { binary: true });
        }
      });

      // Call migrateFolder function after unzipping
      migrateFolder(zip).then(function(files) {
        confirmFiles(files).then(function(confirmedFiles) {
          if (confirmedFiles.length > 0) {
            document.getElementById('uploadArea').innerHTML = '<h2 class="text-xl font-bold mb-4">Choose which data you want to migrate</h2><ul id="fileList" class="list-disc pl-8"></ul>';

            const selectedModules = []; // Array to store selected modules
            confirmedFiles.forEach(function(fileName, index) {
              setTimeout(() => {
                const listItem = document.createElement('li');
                listItem.classList.add("flex", "items-center", "transition", "transform", "ease-in-out", "duration-300", "hover:scale-105", "delay-800", "animate__animated", "animate__fadeIn", "animate__delay-" + (index + 1), "animate__slideInFromTop");

                const checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.name = "file";
                checkbox.value = fileName;
                checkbox.classList.add("opacity-0");
                listItem.appendChild(checkbox);

                const textNode = document.createTextNode(formatFileName(fileName));
                if (textNode) { // Only append text if it's not null
                  const textContainer = document.createElement('span');
                  textContainer.appendChild(textNode);
                  textContainer.classList.add("ml-2"); // Adding margin between checkbox and text
                  listItem.appendChild(textContainer);
                }

                document.getElementById('fileList').appendChild(listItem);

                // Trigger reflow to ensure checkbox and textNode are painted before adding fadeIn animation
                void listItem.offsetWidth;

                checkbox.classList.add("opacity-100", "transition", "duration-300", "delay-800", "animate__animated", "animate__fadeIn", "animate__delay-" + (index + 1));

                // Event listener to add or remove item from selectedModules array
                checkbox.addEventListener('change', function() {
                  if (this.checked) {
                    selectedModules.push(this.value);
                  } else {
                    const index = selectedModules.indexOf(this.value);
                    if (index !== -1) {
                      selectedModules.splice(index, 1);
                    }
                  }
                });
              }, 800 * index);
            });

            const confirmButton = document.createElement('button');
            confirmButton.textContent = "Confirm";
            confirmButton.classList.add("bg-blue-500", "hover:bg-blue-700", "text-white", "font-bold", "py-2", "px-4", "rounded", "transition", "duration-300", "ease-in-out", "mt-4", "inline-block");
            confirmButton.addEventListener('click', function() {
              if (selectedModules.length === 0) {
                alert("Please select data for migration.");
              } else {
                selectedModules.forEach(function(moduleName) {
                  const moduleButton = document.createElement('button');
                  moduleButton.textContent = moduleName;
                  moduleButton.classList.add("bg-green-500", "hover:bg-green-700", "text-white", "font-bold", "py-2", "px-4", "rounded", "mt-4", "mr-4");
                  document.getElementById('uploadArea').appendChild(moduleButton);
                  const uploadButton = document.createElement('button');
                  uploadButton.textContent = "Upload";
                  uploadButton.classList.add("bg-blue-500", "hover:bg-blue-700", "text-white", "font-bold", "py-2", "px-4", "rounded", "mt-4");
                  document.getElementById('uploadArea').appendChild(uploadButton);
                  document.getElementById('uploadArea').appendChild(document.createElement('br'));
                });
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('uploadArea').removeChild(confirmButton);
                document.getElementById('uploadArea').removeChild(chooseDataText);
              }
            });

            document.getElementById('uploadArea').appendChild(confirmButton);
            const chooseDataText = document.createElement('h2');
            chooseDataText.textContent = "Choose which data you want to migrate";
            chooseDataText.classList.add("text-xl", "font-bold", "mb-4");
            document.getElementById('uploadArea').insertBefore(chooseDataText, document.getElementById('fileList'));
          } else {
            console.log("No files selected for migration.");
          }
        });
      });
    });
  }

  async function migrateFolder(zip) {
    const topLevelFolders = Object.keys(zip.files);
    const adaptersFolderName = topLevelFolders.find(folderName => folderName.endsWith('/adapters/'));
    if (!adaptersFolderName) return []; // If adapters folder doesn't exist, return an empty array

    const adaptersFolder = zip.folder(adaptersFolderName);
    const files = [];
    await adaptersFolder.forEach(async function(relativePath, zipEntry) {
      if (!zipEntry.dir) { // If it's a file
        files.push(zipEntry.name);
      }
    });

    // Remove the first item from the array
    files.shift();

    return files;
  }

  function confirmFiles(files) {
    const confirmedFiles = [];
    if (files.length === 0) {
      alert("No files found in the 'adapters' folder.");
      return Promise.resolve(confirmedFiles);
    }

    return new Promise(function(resolve) {
      resolve(files);
    });
  }

  function formatFileName(filePath) {
    const formattedFileName = filePath.split('/').pop().replace(/\.jar$/i, '').replace(/([a-z])([A-Z])/g, '$1 $2').replace(/Adapter/g, '').trim();
    return formattedFileName.includes("Basic") ? null : formattedFileName;
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</body>
</html>
