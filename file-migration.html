<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Migration Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen">
<div class="container text-center">
  <h1 class="text-3xl font-bold text-gray-800 mb-8">File Migration Tool</h1>
  <div id="dropZonesContainer" class="flex flex-wrap justify-center"></div>
  <button id="migrateBtn" class="migrate-btn bg-blue-500 text-white font-bold py-2 px-4 rounded transition duration-300 hover:bg-blue-700 transform hover:scale-105">Migrate Files</button>
  <div id="progressBar" class="progress-bar hidden bg-gray-300 h-2 rounded-full mt-8"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const dropZonesContainer = document.getElementById('dropZonesContainer');
    let selectedFolder = null;

    const checkForTypewriterJar = async (entry, path = '') => {
      if (entry.isFile) {
        const file = await new Promise((resolve, reject) => {
          entry.file(resolve, reject);
        });
        if (file.name === 'typewriter.jar') {
          console.log('Found "typewriter.jar" in the folder.');
          // After finding 'typewriter.jar', look for a folder named 'Typewriter'
          const dirReader = entry.createReader();
          const entries = await new Promise((resolve, reject) => {
            dirReader.readEntries(resolve, reject);
          });
          for (const subEntry of entries) {
            if (subEntry.isDirectory && subEntry.name === 'Typewriter') {
              console.log('Found "Typewriter" folder in the folder.');
              // After finding 'Typewriter' folder, look for a folder named 'adapters'
              const typewriterDirReader = subEntry.createReader();
              const typewriterEntries = await new Promise((resolve, reject) => {
                typewriterDirReader.readEntries(resolve, reject);
              });
              for (const typewriterSubEntry of typewriterEntries) {
                if (typewriterSubEntry.isDirectory && typewriterSubEntry.name === 'adapters') {
                  console.log('Found "adapters" folder in the "Typewriter" folder.');
                  // After finding 'adapters' folder, create an array of jar file names
                  const adaptersDirReader = typewriterSubEntry.createReader();
                  const adaptersEntries = await new Promise((resolve, reject) => {
                    adaptersDirReader.readEntries(resolve, reject);
                  });
                  const jarFiles = [];
                  for (const adaptersSubEntry of adaptersEntries) {
                    if (adaptersSubEntry.isFile && adaptersSubEntry.name.endsWith('.jar')) {
                      jarFiles.push(adaptersSubEntry.name.replace('.jar', ''));
                    }
                  }
                  console.log('Jar files in "adapters" folder:', jarFiles);
                }
              }
            }
          }
        }
      } else if (entry.isDirectory) {
        const dirReader = entry.createReader();
        const entries = await new Promise((resolve, reject) => {
          dirReader.readEntries(resolve, reject);
        });
        for (const subEntry of entries) {
          await checkForTypewriterJar(subEntry, `${path + entry.name}/`);
        }
      }
    };

    const restructureFiles = async (entry, path = '') => {
      let modifiedEntry = entry;
      if (path === '' && entry.name !== 'plugins') {
        const userConfirmation = confirm('The uploaded folder is not named "plugins". Are you sure you want to continue?');
        if (!userConfirmation) {
          return;
        } else {
          await checkForTypewriterJar(entry, path);
        }
      }
      if (entry.isFile) {
        const file = await new Promise((resolve, reject) => {
          entry.file(resolve, reject);
        });
        // Modify the file structure here as needed
      } else if (entry.isDirectory) {
        const dirReader = entry.createReader();
        const entries = await new Promise((resolve, reject) => {
          dirReader.readEntries(resolve, reject);
        });
        for (const subEntry of entries) {
          await restructureFiles(subEntry, `${path + entry.name}/`);
        }
      }
      return modifiedEntry;
    };

    const processFolder = async (folder) => {
      const modifiedFolder = await restructureFiles(folder);
      console.log('Processing folder:', modifiedFolder);
      return modifiedFolder;
    };

    const downloadFolder = async (folder) => {
      const zip = new JSZip();

      const addFilesToZip = async (entry, path = '') => {
        if (entry.isFile) {
          const file = await new Promise((resolve, reject) => {
            entry.file(resolve, reject);
          });
          zip.file(path + entry.name, file);
        } else if (entry.isDirectory) {
          const dirReader = entry.createReader();
          const entries = await new Promise((resolve, reject) => {
            dirReader.readEntries(resolve, reject);
          });
          for (const subEntry of entries) {
            await addFilesToZip(subEntry, `${path + entry.name}/`);
          }
        }
      };

      await addFilesToZip(folder);

      const content = await zip.generateAsync({ type: 'blob' });

      const url = window.URL.createObjectURL(content);
      const element = document.createElement('a');
      element.href = url;
      element.setAttribute('download', 'folder.zip');
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);

      window.URL.revokeObjectURL(url);
    };

    const handleFolderDrop = async (file) => {
      const zip = new JSZip();
      const data = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
      const unzipped = await zip.loadAsync(data);
      for (const fileName in unzipped.files) {
        const fileEntry = unzipped.file(fileName);
        if (fileEntry) {
          const content = await fileEntry.async('blob');
          const file = new File([content], fileName);
          await processFolder(file);
        }
      }
    };

    const handleClick = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.zip';
      input.onchange = async (event) => {
        const files = Array.from(event.target.files);
        if (files.length > 0) {
          const file = files[0];
          await handleFolderDrop(file);
        }
      };
      input.click();
    };

    dropZonesContainer.innerHTML = `
    <div class="drop-zone border-2 border-dashed border-gray-300 rounded-md p-8 mb-8 mr-8">
      <p class="text-gray-500">Click here to select your server's plugin folder</p>
    </div>
  `;
    const dropZone = dropZonesContainer.querySelector('.drop-zone');

    dropZone.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', async (event) => {
      event.preventDefault();
      dropZone.classList.remove('dragover');

      const items = event.dataTransfer.items;
      if (items.length > 0 && items[0].webkitGetAsEntry) {
        const entry = items[0].webkitGetAsEntry();
        if (entry.isDirectory) {
          await handleFolderDrop(entry);
        }
      }
    });

    const migrateBtn = document.getElementById('migrateBtn');
    migrateBtn.addEventListener('click', async () => {
      if (selectedFolder) {
        await downloadFolder(selectedFolder);
      } else {
        alert('Please select a folder to migrate.');
      }
    });

    dropZone.addEventListener('click', () => {
      handleClick();
    });
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</body>
</html>
