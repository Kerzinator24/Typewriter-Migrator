<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zip File Uploader</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }
    #uploadButton {
      margin: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #fileList {
      list-style-type: none;
      padding: 0;
    }
    #fileList li {
      margin: 5px;
    }
  </style>
</head>
<body>
<h1>Zip File Uploader</h1>
<input type="file" id="fileInput" style="display: none;" accept=".zip">
<button id="uploadButton">Upload Zip File</button>

<script>
  document.getElementById('uploadButton').addEventListener('click', function() {
    document.getElementById('fileInput').click();
  });

  document.getElementById('fileInput').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const arrayBuffer = e.target.result;
      unzipAndRezip(arrayBuffer);
    };
    reader.readAsArrayBuffer(file);
  });

  function unzipAndRezip(arrayBuffer) {
    JSZip.loadAsync(arrayBuffer).then(function(zip) {
      const newZip = new JSZip();
      zip.forEach(function(relativePath, zipEntry) {
        if (!zipEntry.dir) { // Skip directories
          newZip.file(zipEntry.name, zipEntry.async("arraybuffer"), { binary: true });
        }
      });

      // Call migrateFolder function after unzipping
      migrateFolder(zip).then(function(files) {
        confirmFiles(files).then(function(confirmedFiles) {
          if (confirmedFiles.length > 0) {
            confirmedFiles.forEach(function(fileName) {
              newZip.file(fileName, zip.file(fileName).async("arraybuffer"), { binary: true });
            });
            newZip.generateAsync({ type: "blob" }).then(function(blob) {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'new_zip_file.zip';
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
            });
          } else {
            console.log("No files selected for migration.");
          }
        });
      });
    });
  }

  async function migrateFolder(zip) {
    const topLevelFolders = Object.keys(zip.files);
    const adaptersFolderName = topLevelFolders.find(folderName => folderName.endsWith('/adapters/'));
    if (!adaptersFolderName) return []; // If adapters folder doesn't exist, return an empty array

    const adaptersFolder = zip.folder(adaptersFolderName);
    const files = [];
    await adaptersFolder.forEach(async function(relativePath, zipEntry) {
      if (!zipEntry.dir) { // If it's a file
        files.push(zipEntry.name);
      }
    });

    // Remove the first item from the array
    files.shift();

    return files;
  }

  function confirmFiles(files) {
    const confirmedFiles = [];
    if (files.length === 0) {
      alert("No files found in the 'adapters' folder.");
      return Promise.resolve(confirmedFiles);
    }

    const fileListElement = document.createElement('ul');
    fileListElement.id = "fileList";

    files.forEach(function(fileName) {
      const listItem = document.createElement('li');
      const checkbox = document.createElement('input');
      checkbox.type = "checkbox";
      checkbox.name = "file";
      checkbox.value = fileName;
      listItem.appendChild(checkbox);
      listItem.appendChild(document.createTextNode(fileName));
      fileListElement.appendChild(listItem);
    });

    const confirmButton = document.createElement('button');
    confirmButton.textContent = "Confirm";
    confirmButton.addEventListener('click', function() {
      const checkedFiles = Array.from(document.querySelectorAll('input[name="file"]:checked')).map(function(checkbox) {
        return checkbox.value;
      });
      confirmedFiles.push(...checkedFiles);
      document.body.removeChild(fileListElement);
      document.body.removeChild(confirmButton);
    });

    document.body.appendChild(fileListElement);
    document.body.appendChild(confirmButton);

    return new Promise(function(resolve) {
      confirmButton.addEventListener('click', function() {
        resolve(confirmedFiles);
      });
    });
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</body>
</html>
